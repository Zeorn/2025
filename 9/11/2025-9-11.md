#### 《社会工程学之网络追踪》获取对方真实IP和运营商｜牛马小试 | 第二节

学会本节可获得如下技能：

•对方的手机电脑等设备型号

•对方用的什么浏览器什么版本

•对方网络IP地址信息

•对方有没有开VPN

•对方用的什么运营商

•对方大概在哪个城市

****

视频讲解：https://youtu.be/v94iiGNOw8k

成为我的VIP会员：
https://www.youtube.com/@MeeGooBoo/join

> 二、《社会工程学之网络追踪》-获取对方真实IP地址和运营商.pptx 

本节课的PPT下载地址：https://github.com/MeeGooBoo/2025/blob/main/9/11/%E4%BA%8C%E3%80%81%E3%80%8A%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B%E5%AD%A6%E4%B9%8B%E7%BD%91%E7%BB%9C%E8%BF%BD%E8%B8%AA%E3%80%8B-%E8%8E%B7%E5%8F%96%E5%AF%B9%E6%96%B9%E7%9C%9F%E5%AE%9EIP%E5%9C%B0%E5%9D%80%E5%92%8C%E8%BF%90%E8%90%A5%E5%95%86.pptx

**点击右上角的三个点即可看到下载按钮**

****

腾讯构建：https://cnb.cool/

二维码工具：https://cli.im/

IP详细查询：https://tool.lu/ip/

```
apt update
```

```
apt install python3 python3-pip
```

```
pip install --break-system-packages flask requests
```

```
from flask import Flask, request, render_template_string
import requests
import datetime
import os
import logging
import json
from werkzeug.middleware.proxy_fix import ProxyFix

# 设置日志
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

app = Flask(__name__)

# 配置代理中间件
app.wsgi_app = ProxyFix(app.wsgi_app, x_for=1, x_proto=1, x_host=1, x_port=1)

# 用于检测代理的IP服务API（实际使用时可能需要注册获取API密钥）
PROXY_CHECK_API = "http://ip-api.com/json/{ip}?fields=proxy,countryCode,city,isp&lang=zh-CN"

# 国家代码到中文名称的映射
COUNTRY_CODE_MAP = {
    "CN": "中国", "US": "美国", "JP": "日本", "KR": "韩国", "UK": "英国",
    "DE": "德国", "FR": "法国", "RU": "俄罗斯", "IN": "印度", "BR": "巴西",
    "CA": "加拿大", "AU": "澳大利亚", "SG": "新加坡", "TW": "台湾", "HK": "香港",
    "MO": "澳门", "MY": "马来西亚", "TH": "泰国", "VN": "越南", "ID": "印度尼西亚",
    "PH": "菲律宾", "MM": "缅甸", "KH": "柬埔寨", "LA": "老挝", "BD": "孟加拉国",
    "NP": "尼泊尔", "PK": "巴基斯坦", "LK": "斯里兰卡", "SA": "沙特阿拉伯",
    "AE": "阿联酋", "TR": "土耳其", "IL": "以色列", "EG": "埃及", "ZA": "南非",
    "NG": "尼日利亚", "KE": "肯尼亚", "ET": "埃塞俄比亚", "MA": "摩洛哥"
}

def is_private_ip(ip):
    """检查IP是否为内网IP"""
    if not ip or ip in ['127.0.0.1', '::1', 'localhost']:
        return True
    
    try:
        # 处理IPv4
        if '.' in ip:
            ip_parts = ip.split('.')
            if len(ip_parts) != 4:
                return False
                
            if ip_parts[0] == '10':
                return True
            if ip_parts[0] == '172' and 16 <= int(ip_parts[1]) <= 31:
                return True
            if ip_parts[0] == '192' and ip_parts[1] == '168':
                return True
            if ip_parts[0] == '169' and ip_parts[1] == '254':
                return True
        # 处理IPv6本地地址
        elif ':' in ip:
            if ip.startswith('fc00:') or ip.startswith('fd00:') or ip == '::1':
                return True
            if ip.startswith('fe80:'):  # 链路本地地址
                return True
    except (ValueError, IndexError):
        pass
    
    return False

def check_ip_proxy_and_location(ip):
    """
    检查IP是否为代理/VPN并获取归属地信息
    返回格式: (is_proxy, location_str)
    """
    try:
        # 跳过本地IP检查
        if is_private_ip(ip):
            return False, "本地网络"
            
        response = requests.get(PROXY_CHECK_API.format(ip=ip), timeout=5)
        data = response.json()
        
        # 检查是否是代理
        is_proxy = data.get('proxy', False) or data.get('hosting', False)
        
        # 获取国家代码并转换为中文
        country_code = data.get('countryCode', '')
        country = COUNTRY_CODE_MAP.get(country_code, country_code)
        
        # 获取其他信息
        city = data.get('city', '未知')
        isp = data.get('isp', '未知')
        
        # 构建位置字符串
        location = f"{country} {city} {isp}"
        
        return is_proxy, location
    except Exception as e:
        logger.error(f"查询IP信息出错: {e}")
        return False, "未知位置"

def get_client_ip():
    """获取客户端真实IP地址"""
    # 可能的代理头部字段（按优先级排序）
    proxy_headers = [
        'X-Forwarded-For',
        'X-Real-IP',
        'X-Client-IP',
        'CF-Connecting-IP',  # Cloudflare
        'True-Client-IP',
        'X-Cluster-Client-IP',
        'Forwarded-For',
        'Forwarded',
    ]
    
    # 检查所有可能的头部
    for header in proxy_headers:
        ip = request.headers.get(header)
        if ip:
            logger.info(f"从头部 {header} 找到IP: {ip}")
            
            # 处理多个IP的情况（如X-Forwarded-For: client, proxy1, proxy2）
            if ',' in ip:
                ips = [ip.strip() for ip in ip.split(',')]
                # 取第一个非内网IP
                for candidate_ip in ips:
                    if not is_private_ip(candidate_ip):
                        logger.info(f"从头部 {header} 获取到真实IP: {candidate_ip}")
                        return candidate_ip
                # 如果没有公网IP，返回第一个IP
                logger.info(f"从头部 {header} 获取到IP: {ips[0]}")
                return ips[0]
            elif ip and not is_private_ip(ip):
                logger.info(f"从头部 {header} 获取到公网IP: {ip}")
                return ip
            elif ip:
                logger.info(f"从头部 {header} 获取到内网IP: {ip}")
    
    # 如果所有头部都没有或都是内网IP，使用remote_addr
    ip = request.remote_addr
    logger.info(f"使用remote_addr获取IP: {ip}")
    return ip

def get_all_headers():
    """获取所有请求头信息"""
    headers = {}
    for key, value in request.headers:
        headers[key] = value
    return headers

def save_to_file(ip, is_proxy, location, headers):
    """将结果保存到txt文件，包括请求头信息"""
    timestamp = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    proxy_status = "代理IP" if is_proxy else "真实IP"
    
    # 构建日志条目
    log_entry = f"{timestamp} | {ip} | {proxy_status} | {location}\n"
    
    # 添加请求头信息
    log_entry += "请求头信息:\n"
    for key, value in headers.items():
        log_entry += f"  {key}: {value}\n"
    log_entry += "-" * 50 + "\n"
    
    # 写入文件
    with open("ip_access_log.txt", "a", encoding="utf-8") as f:
        f.write(log_entry)
    
    return log_entry

# HTML模板
HTML_TEMPLATE = """
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP信息查询</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 40px;
            max-width: 700px;
            width: 100%;
            transition: transform 0.3s ease;
        }
        .container:hover {
            transform: translateY(-5px);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-weight: 600;
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
        }
        .info-grid {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        .info-label {
            font-weight: bold;
            color: #555;
            text-align: right;
            padding-right: 15px;
        }
        .info-value {
            color: #333;
            word-break: break-all;
        }
        .ip-type {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-top: 5px;
        }
        .proxy {
            background-color: #ffebee;
            color: #c62828;
        }
        .real {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .timestamp {
            text-align: center;
            color: #7f8c8d;
            margin-top: 30px;
            font-size: 0.9em;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        .request-headers {
            margin-top: 30px;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.85em;
            max-height: 200px;
            overflow-y: auto;
        }
        .request-headers h3 {
            margin-top: 0;
            color: #555;
        }
        .debug-info {
            margin-top: 20px;
            padding: 15px;
            background-color: #fff3cd;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>IP信息查询结果</h1>
        
        <div class="info-grid">
            <div class="info-label">IP地址:</div>
            <div class="info-value">{{ ip }}</div>
            
            <div class="info-label">IP类型:</div>
            <div class="info-value">
                <span class="ip-type {{ 'proxy' if is_proxy else 'real' }}">
                    {% if is_proxy %}代理IP{% else %}真实IP{% endif %}
                </span>
            </div>
            
            <div class="info-label">地理位置:</div>
            <div class="info-value">{{ location }}</div>
            
            <div class="info-label">检测时间:</div>
            <div class="info-value">{{ timestamp }}</div>
        </div>
        
        {% if debug_info %}
        <div class="debug-info">
            <strong>调试信息:</strong><br>
            {{ debug_info }}
        </div>
        {% endif %}
        
        <div class="request-headers">
            <h3>请求头信息 (用于调试):</h3>
            {% for header, value in headers.items() %}
                <div><strong>{{ header }}:</strong> {{ value }}</div>
            {% endfor %}
        </div>
        
        <div class="timestamp">
            系统运行于Docker容器 | {{ hostname }}
        </div>
    </div>
</body>
</html>
"""

@app.route('/')
def index():
    """主访问接口"""
    # 获取客户端IP
    ip = get_client_ip()
    
    # 检查IP是否为代理并获取位置信息
    is_proxy, location = check_ip_proxy_and_location(ip)
    
    # 获取所有请求头
    headers = get_all_headers()
    
    # 保存到文件（包括请求头信息）
    log_entry = save_to_file(ip, is_proxy, location, headers)
    
    # 获取当前时间戳
    timestamp = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    
    # 获取主机名（用于显示容器信息）
    hostname = os.getenv('HOSTNAME', '未知容器')
    
    # 调试信息
    debug_info = None
    if is_private_ip(ip):
        debug_info = "检测到内网IP，请确保反向代理正确配置了X-Forwarded-For等头部"
    
    # 使用HTML模板渲染响应
    return render_template_string(HTML_TEMPLATE, 
                                 ip=ip, 
                                 is_proxy=is_proxy, 
                                 location=location, 
                                 timestamp=timestamp,
                                 headers=headers,
                                 hostname=hostname,
                                 debug_info=debug_info)

@app.route('/logs')
def show_logs():
    """显示日志文件内容"""
    try:
        with open("ip_access_log.txt", "r", encoding="utf-8") as f:
            logs = f.read()
        return f"<pre>{logs}</pre>"
    except FileNotFoundError:
        return "日志文件不存在"

@app.route('/debug')
def debug_headers():
    """调试页面，显示所有头部信息"""
    headers = {key: value for key, value in request.headers}
    client_ip = get_client_ip()
    remote_addr = request.remote_addr
    
    debug_info = {
        "client_ip_from_function": client_ip,
        "remote_addr": remote_addr,
        "is_private_ip": is_private_ip(client_ip),
        "headers": headers
    }
    
    return json.dumps(debug_info, indent=2, ensure_ascii=False)

if __name__ == '__main__':
    # 获取端口，默认为5000
    port = int(os.environ.get('PORT', 5000))
    
    # 启动应用
    app.run(host='0.0.0.0', port=port, debug=False)
```





****

****

#### 攻防无绝对，技术无好坏，在非安全的信息时代，众人皆在囚笼之中，关注牛马小试，让你一飞冲天！

****

- **Telegram(文件资源频道)：https://t.me/NiuMaXiaoShi**
- **Youtube：  https://www.youtube.com/@MeeGooBoo**
- **Twitter ( X ）：  https://x.com/MeeGooBoo**

****

- ###### 需要联系我？请通过：https://t.me/MeeGooBoo
- 如需购买钻石、铂金、黄金相关珠宝首饰的，请加我微信：Aioa700
- 注：本人不参与任何涉政相关讨论，本人所有平台和内容仅供技术相关领域学习交流使用。

****

>  [!CAUTION]
>
> 本仓库所有内容均来自互联网公开内容或本仓库所有者创作，请勿相信资源中的广告，主动联系你的都是骗子，提高智商谨防上当受诈！请勿利用本仓库实施违反任何适用法律法规等犯罪活动！本仓库所有者不对因使用本仓库内容导致的任何后果承担责任！

****

## 你的赞助是功德无量💰

>  [!NOTE]
>
> 如果你觉得本仓库对你有帮助，你可以赞助我们一杯咖啡，鼓励我们继续维护下去。<br>
> 成为我的Patreon会员：https://www.patreon.com/MeeGooBoo/membership<br>
> 通过Paypal支持我：https://paypal.me/MoGuoBiao<br>
> 通过比特币支持我：bc1qkwrq5plek62fmfaynyphfuuepm6cxd4fsh5wrp



<p align="center" >
    <img src="https://raw.githubusercontent.com/MeeGooBoo/2025/refs/heads/main/static/imgs/logo.png" width="150">
    <h3 align="center">牛马小试(莫国标)</h3>
    <p align="center">
        <img src="https://raw.githubusercontent.com/MeeGooBoo/2025/refs/heads/main/static/imgs/pays.png">
    </p>
</p>


****





